```
ğŸ”’ SEGURIDAD DEL WEBHOOK - FLOW PAYMENT GATEWAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ANTES (âŒ VULNERABLE):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /flow/confirm                         â”‚
â”‚  {                                          â”‚
â”‚    "token": "abc123"                        â”‚
â”‚  }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Consultar Flow API â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Actualizar pedido  â”‚ â† âŒ SIN VALIDACIONES
    â”‚ estado = 'pagado'  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PROBLEMAS:
âœ— Cualquiera puede enviar POST
âœ— Tokens se pueden reutilizar
âœ— Montos pueden ser manipulados
âœ— Sin verificaciÃ³n de origen


AHORA (âœ… SEGURO):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /flow/confirm                         â”‚
â”‚  {                                          â”‚
â”‚    "token": "abc123",                       â”‚
â”‚    "s": "firma_hmac_sha256"  â†â”€â”€â”€â”€â”€â”       â”‚
â”‚  }                                  â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                        â”‚
             â”‚                        â”‚
        1ï¸âƒ£  â”‚ Validar Firma          â”‚
             â”‚                        â”‚
             â–¼                        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚ flowSign(params)    â”‚          â”‚
    â”‚ === receivedSign?   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ âœ… VÃ¡lida
             â”‚
        2ï¸âƒ£  â”‚ Replay Attack?
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ isTokenProcessed?   â”‚
    â”‚ NO â†’ Continuar      â”‚
    â”‚ SÃ â†’ 409 Conflict   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ âœ… Token Ãºnico
             â”‚
        3ï¸âƒ£  â”‚ Consultar Flow
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ GET Flow API        â”‚
    â”‚ /payment/getStatus  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ {flowOrder, status, amount...}
             â”‚
        4ï¸âƒ£  â”‚ Datos completos?
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ flowOrder âœ“             â”‚
    â”‚ commerceOrder âœ“         â”‚
    â”‚ status âœ“                â”‚
    â”‚ amount > 0 âœ“            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ âœ… Validado
             â”‚
        5ï¸âƒ£  â”‚ Validar monto
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Buscar pedido en Firebase   â”‚
    â”‚ montoEsperado = totalCLP    â”‚
    â”‚ montoPagado = amount        â”‚
    â”‚                             â”‚
    â”‚ diferencia = |pagado-esper| â”‚
    â”‚                             â”‚
    â”‚ diferencia > 1 CLP?         â”‚
    â”‚   SÃ â†’ 400 Bad Request      â”‚
    â”‚   NO â†’ Continuar            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ âœ… Monto correcto
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ… TODAS LAS VALIDACIONES   â”‚
    â”‚    PASADAS                  â”‚
    â”‚                             â”‚
    â”‚ Actualizar Firebase:        â”‚
    â”‚ â€¢ estado = 'pagado'         â”‚
    â”‚ â€¢ flowOrder = XXX           â”‚
    â”‚ â€¢ paymentDate = now()       â”‚
    â”‚ â€¢ paymentData = {status...} â”‚
    â”‚                             â”‚
    â”‚ Enviar email confirmaciÃ³n   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PROTECCIONES ACTIVAS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… 1. FIRMA DIGITAL (HMAC-SHA256)
   â€¢ Verifica que viene de Flow
   â€¢ Previene webhooks falsos
   â€¢ Status: 401 si falla

âœ… 2. REPLAY ATTACK PROTECTION
   â€¢ Cada token se procesa 1 sola vez
   â€¢ TTL: 10 minutos
   â€¢ Status: 409 si se repite

âœ… 3. VALIDACIÃ“N DE DATOS
   â€¢ flowOrder obligatorio
   â€¢ commerceOrder obligatorio
   â€¢ status obligatorio
   â€¢ amount > 0
   â€¢ Status: 400 si falta algo

âœ… 4. VALIDACIÃ“N DE MONTO
   â€¢ Compara con pedido original
   â€¢ Tolerancia: Â±1 CLP
   â€¢ Estado especial: 'discrepancia_monto'
   â€¢ Status: 400 si no coincide

âœ… 5. CONSULTA DIRECTA A FLOW
   â€¢ No confÃ­a solo en el webhook
   â€¢ Verifica estado real del pago
   â€¢ Doble verificaciÃ³n


ATAQUES BLOQUEADOS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš« Webhook Spoofing
   Atacante: POST falso a /flow/confirm
   Bloqueado por: Firma HMAC invÃ¡lida â†’ 401

ğŸš« Replay Attack
   Atacante: ReenvÃ­a webhook vÃ¡lido antiguo
   Bloqueado por: Token ya procesado â†’ 409

ğŸš« Amount Manipulation
   Atacante: Modifica amount en webhook
   Bloqueado por: VerificaciÃ³n con Flow API + validaciÃ³n vs DB

ğŸš« Partial Payment Fraud
   Atacante: Paga $100, simula $10.000
   Bloqueado por: ValidaciÃ³n de monto â†’ 400

ğŸš« Race Condition
   Atacante: EnvÃ­a mÃºltiples webhooks simultÃ¡neos
   Bloqueado por: Marcado atÃ³mico de token


TESTING:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

npm run test:security

Tests incluidos:
â€¢ Webhook sin token â†’ 400
â€¢ Webhook sin firma â†’ Advertencia
â€¢ Firma invÃ¡lida â†’ 401
â€¢ Firma vÃ¡lida â†’ Procesado
â€¢ Replay attack â†’ 409


MONITOREO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Logs de seguridad (buscar ğŸš¨):

grep "ğŸš¨ \[SECURITY\]" logs/app.log

Eventos crÃ­ticos:
â€¢ Firma invÃ¡lida (posible ataque)
â€¢ Token duplicado (replay attack)
â€¢ Discrepancia de monto (fraude o bug)


PRODUCCIÃ“N:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Recomendaciones adicionales:

1. Redis para tokens procesados
   â€¢ Funciona con mÃºltiples instancias
   â€¢ Persistente entre reinicios

2. Rate Limiting
   â€¢ MÃ¡ximo 10 req/min por IP
   â€¢ Previene fuerza bruta

3. Alertas de seguridad
   â€¢ Email/Slack en eventos crÃ­ticos
   â€¢ RevisiÃ³n manual de discrepancias

4. HTTPS obligatorio
   â€¢ SSL/TLS en producciÃ³n
   â€¢ Certificados Let's Encrypt


NIVEL DE SEGURIDAD:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Actual:      ğŸ”’ğŸ”’ğŸ”’ğŸ”’ (4/5)
Con Redis:   ğŸ”’ğŸ”’ğŸ”’ğŸ”’ğŸ”’ (5/5)

Estado: âœ… PRODUCCIÃ“N READY
```
