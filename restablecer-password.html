<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restablecer Contraseña - Misión 3D</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body.login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
      padding: 20px;
    }
    
    body.dark.login-page {
      background: #0f172a;
    }
    
    .reset-container {
      max-width: 600px;
      width: 100%;
      background: #fff;
      border-radius: 12px;
      padding: 50px;
      box-shadow: 0 4px 20px rgba(0,0,0,.08);
      text-align: center;
    }
    
    body.dark .reset-container {
      background: #1e293b;
    }
    
    .reset-title-small {
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    
    .reset-title {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 10px;
    }
    
    .reset-subtitle {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 30px;
    }
    
    body.dark .reset-title {
      color: #f1f5f9;
    }
    
    body.dark .reset-title-small,
    body.dark .reset-subtitle {
      color: #94a3b8;
    }
    
    .success-message {
      background: #d1fae5;
      border: 1px solid #6ee7b7;
      color: #065f46;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      font-size: 15px;
      line-height: 1.6;
      display: none;
    }
    
    .success-message.active {
      display: block;
    }
    
    .error-message {
      background: #fee2e2;
      border: 1px solid #fca5a5;
      color: #991b1b;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      font-size: 15px;
      line-height: 1.6;
      display: none;
    }
    
    .error-message.active {
      display: block;
    }
    
    body.dark .success-message {
      background: #064e3b;
      border-color: #059669;
      color: #6ee7b7;
    }
    
    body.dark .error-message {
      background: #7f1d1d;
      border-color: #dc2626;
      color: #fca5a5;
    }
    
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    .form-label {
      display: block;
      font-size: 15px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }
    
    body.dark .form-label {
      color: #e2e8f0;
    }
    
    .password-input-wrapper {
      position: relative;
    }
    
    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 15px;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #0ea5e9;
    }
    
    body.dark .form-input {
      background: #334155;
      border-color: #475569;
      color: #f1f5f9;
    }
    
    body.dark .form-input:focus {
      border-color: #0ea5e9;
    }
    
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }
    
    .password-toggle:hover {
      color: #0ea5e9;
    }
    
    .password-toggle svg {
      width: 20px;
      height: 20px;
    }
    
    body.dark .password-toggle {
      color: #94a3b8;
    }
    
    body.dark .password-toggle:hover {
      color: #38bdf8;
    }
    
    .password-requirements {
      margin-top: 8px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    
    .password-requirements small {
      display: block;
      color: #6b7280;
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .password-requirements ul {
      list-style: none;
      padding: 0;
      margin: 0;
      text-align: left;
    }
    
    .password-requirements li {
      font-size: 13px;
      color: #dc2626;
      padding: 3px 0;
      transition: color 0.2s;
    }
    
    .password-requirements li.valid {
      color: #16a34a;
    }
    
    body.dark .password-requirements {
      background: #1e293b;
      border-color: #334155;
    }
    
    body.dark .password-requirements small {
      color: #94a3b8;
    }
    
    body.dark .password-requirements li {
      color: #ef4444;
    }
    
    body.dark .password-requirements li.valid {
      color: #22c55e;
    }
    
    .btn-reset {
      width: 100%;
      padding: 14px;
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 20px;
    }
    
    .btn-reset:hover {
      background: #0284c7;
    }
    
    .btn-reset:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .back-link {
      display: inline-block;
      color: #0ea5e9;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      transition: color 0.2s;
    }
    
    .back-link:hover {
      color: #0284c7;
      text-decoration: underline;
    }
    
    body.dark .back-link {
      color: #38bdf8;
    }
    
    body.dark .back-link:hover {
      color: #0ea5e9;
    }
    
    @media (max-width: 768px) {
      .reset-container {
        padding: 30px 20px;
      }
      
      .reset-title {
        font-size: 24px;
      }
    }
  </style>
</head>
<body class="login-page">
  <div class="reset-container">
    <div class="reset-title-small">RESTABLECER CONTRASEÑA</div>
    <h1 class="reset-title">MISION3D.CL</h1>
    <p class="reset-subtitle">Ingresa tu nueva contraseña</p>
    
    <!-- Mensaje de éxito -->
    <div class="success-message" id="successMessage">
      ✅ Tu contraseña ha sido restablecida exitosamente. Redirigiendo al login...
    </div>
    
    <!-- Mensaje de error -->
    <div class="error-message" id="errorMessage"></div>
    
    <form id="resetForm">
      <div class="form-group">
        <label class="form-label" for="newPassword">Nueva Contraseña *</label>
        <div class="password-input-wrapper">
          <input type="password" id="newPassword" class="form-input" required autocomplete="new-password">
          <button type="button" class="password-toggle" onclick="togglePassword('newPassword', this)">
            <svg class="eye-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <svg class="eye-closed" style="display:none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
            </svg>
          </button>
        </div>
        <div class="password-requirements">
          <small>La contraseña debe contener:</small>
          <ul>
            <li id="req-length">✗ Mínimo 8 caracteres</li>
            <li id="req-letter">✗ Al menos una letra</li>
            <li id="req-number">✗ Al menos un número</li>
            <li id="req-special">✗ Al menos un signo especial (!@#$%^&*)</li>
          </ul>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="confirmPassword">Confirmar Nueva Contraseña *</label>
        <div class="password-input-wrapper">
          <input type="password" id="confirmPassword" class="form-input" required autocomplete="new-password">
          <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)">
            <svg class="eye-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <svg class="eye-closed" style="display:none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <button type="submit" class="btn-reset" id="submitBtn">CAMBIAR CONTRASEÑA</button>
      
      <a href="login.html" class="back-link">Volver al Login</a>
    </form>
  </div>

  <script>
    // Función para mostrar/ocultar contraseña
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      const eyeOpen = button.querySelector('.eye-open');
      const eyeClosed = button.querySelector('.eye-closed');
      
      if (input.type === 'password') {
        input.type = 'text';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'block';
      } else {
        input.type = 'password';
        eyeOpen.style.display = 'block';
        eyeClosed.style.display = 'none';
      }
    }
    
    // Heredar tema oscuro si existe
    if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
    
    const resetForm = document.getElementById('resetForm');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');
    
    // Obtener token de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    // Validar que exista token
    if (!token) {
      errorMessage.textContent = '❌ Link inválido. Por favor solicita un nuevo enlace de recuperación.';
      errorMessage.classList.add('active');
      resetForm.style.display = 'none';
    }
    
    // Validación en tiempo real de la contraseña
    newPasswordInput.addEventListener('input', () => {
      const password = newPasswordInput.value;
      
      // Validar longitud
      const lengthReq = document.getElementById('req-length');
      if (password.length >= 8) {
        lengthReq.classList.add('valid');
        lengthReq.textContent = '✓ Mínimo 8 caracteres';
      } else {
        lengthReq.classList.remove('valid');
        lengthReq.textContent = '✗ Mínimo 8 caracteres';
      }
      
      // Validar letra
      const letterReq = document.getElementById('req-letter');
      if (/[a-zA-Z]/.test(password)) {
        letterReq.classList.add('valid');
        letterReq.textContent = '✓ Al menos una letra';
      } else {
        letterReq.classList.remove('valid');
        letterReq.textContent = '✗ Al menos una letra';
      }
      
      // Validar número
      const numberReq = document.getElementById('req-number');
      if (/[0-9]/.test(password)) {
        numberReq.classList.add('valid');
        numberReq.textContent = '✓ Al menos un número';
      } else {
        numberReq.classList.remove('valid');
        numberReq.textContent = '✗ Al menos un número';
      }
      
      // Validar signo especial
      const specialReq = document.getElementById('req-special');
      if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
        specialReq.classList.add('valid');
        specialReq.textContent = '✓ Al menos un signo especial (!@#$%^&*)';
      } else {
        specialReq.classList.remove('valid');
        specialReq.textContent = '✗ Al menos un signo especial (!@#$%^&*)';
      }
    });
    
    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      // Validar campos vacíos
      if (!newPassword || !confirmPassword) {
        alert('Por favor completa todos los campos');
        return;
      }
      
      // Validar contraseña estricta
      if (newPassword.length < 8) {
        alert('La contraseña debe tener al menos 8 caracteres');
        return;
      }
      
      const hasLetter = /[a-zA-Z]/.test(newPassword);
      const hasNumber = /[0-9]/.test(newPassword);
      const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(newPassword);
      
      if (!hasLetter) {
        alert('La contraseña debe contener al menos una letra');
        return;
      }
      
      if (!hasNumber) {
        alert('La contraseña debe contener al menos un número');
        return;
      }
      
      if (!hasSpecial) {
        alert('La contraseña debe contener al menos un signo especial');
        return;
      }
      
      // Validar coincidencia
      if (newPassword !== confirmPassword) {
        alert('Las contraseñas no coinciden');
        return;
      }
      
      // Determinar URL del backend
      const isLocal = /localhost|127\.0\.0\.1/.test(window.location.hostname);
      const backendUrl = isLocal ? '' : window.location.origin;
      
      // Deshabilitar botón
      submitBtn.disabled = true;
      submitBtn.textContent = 'CAMBIANDO...';
      
      // En local, cambiar directamente sin backend
      if (isLocal) {
        console.log('🔧 Modo local: Cambiando contraseña directamente');
        
        // Para desarrollo local, usar un email de prueba si no hay token válido
        // En producción, el token vendría del email
        const testEmail = prompt('🔧 Modo desarrollo - Ingresa el email del usuario:', '');
        
        if (testEmail) {
          // Actualizar contraseña en localStorage
          const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
          const userIndex = registeredUsers.findIndex(u => u.email.toLowerCase() === testEmail.toLowerCase());
          
          if (userIndex !== -1) {
            registeredUsers[userIndex].password = newPassword;
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            
            // Mostrar mensaje de éxito
            resetForm.style.display = 'none';
            successMessage.classList.add('active');
            
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 3000);
          } else {
            errorMessage.textContent = '❌ Usuario no encontrado en desarrollo local';
            errorMessage.classList.add('active');
            submitBtn.disabled = false;
            submitBtn.textContent = 'CAMBIAR CONTRASEÑA';
          }
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'CAMBIAR CONTRASEÑA';
        }
        return;
      }
      
      try {
        // Enviar solicitud al backend
        const response = await fetch(`${backendUrl}/api/reset-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            token,
            newPassword 
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          console.log('✅ Contraseña restablecida');
          
          // Actualizar contraseña en localStorage
          const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
          const userIndex = registeredUsers.findIndex(u => u.email.toLowerCase() === data.email.toLowerCase());
          
          if (userIndex !== -1) {
            registeredUsers[userIndex].password = newPassword;
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
          }
          
          // Mostrar mensaje de éxito
          resetForm.style.display = 'none';
          successMessage.classList.add('active');
          
          // Redirigir al login
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 3000);
        } else {
          errorMessage.textContent = '❌ ' + (data.error || 'Error al restablecer contraseña');
          errorMessage.classList.add('active');
          submitBtn.disabled = false;
          submitBtn.textContent = 'CAMBIAR CONTRASEÑA';
        }
        
      } catch (error) {
        console.error('Error:', error);
        errorMessage.textContent = '❌ Error al conectar con el servidor. Por favor intenta nuevamente.';
        errorMessage.classList.add('active');
        submitBtn.disabled = false;
        submitBtn.textContent = 'CAMBIAR CONTRASEÑA';
      }
    });
  </script>
</body>
</html>
