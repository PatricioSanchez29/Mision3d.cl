<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Producto | Tienda 3D</title><meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="style.css">
<script>window.GA_MEASUREMENT_ID = window.GA_MEASUREMENT_ID || 'G-XXXXXXXXXX';</script>
<script src="consent.js"></script>
<style>
/* Estilos espec√≠ficos p√°gina producto (pueden moverse a style.css luego) */
.product-page{max-width:1250px;margin:40px auto;padding:0 20px;display:grid;grid-template-columns:380px 1fr;gap:50px}
.product-gallery{display:flex;flex-direction:column;gap:14px}
.product-main{position:relative;width:100%;aspect-ratio:1/1;border-radius:14px;overflow:hidden;background:#fafafa;display:flex;align-items:center;justify-content:center}
.product-main img{width:100%;height:100%;object-fit:cover;transition:.4s ease}
.product-thumbs{display:flex;flex-direction:column;gap:10px;max-height:520px;overflow:auto;padding-right:4px}
.product-thumb{width:70px;aspect-ratio:1/1;border:2px solid transparent;border-radius:10px;overflow:hidden;cursor:pointer;flex:0 0 auto;position:relative;background:#f4f4f4}
.product-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.product-thumb.active{border-color:#e6462f}
.breadcrumb{font-size:.85rem;color:#666;margin-bottom:20px}
.breadcrumb a{color:#e6462f;text-decoration:none}
.product-info h1{margin:0 0 8px;font-size:2rem;line-height:1.2}
.price-block{display:flex;align-items:center;gap:10px;margin:12px 0 18px}
.price-final{font-size:2rem;font-weight:700;color:#e6462f}
.price-old{color:#999;text-decoration:line-through;font-size:1rem}
.badges-line{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.badges-line .badge{font-size:.7rem}
.rating-line{display:flex;align-items:center;gap:6px;font-size:.9rem;margin-bottom:14px}
.short-desc{color:#444;line-height:1.45;margin-bottom:20px}
.stock-msg{font-size:.85rem;margin-bottom:12px}
.stock-low{color:#d9534f;font-weight:600}
.qty-box{display:flex;align-items:center;border:1px solid #ddd;border-radius:10px;overflow:hidden;width:max-content;margin:0 0 22px}
.qty-box button{background:#fff;border:none;padding:12px 14px;font-size:1.1rem;cursor:pointer;line-height:1}
.qty-box span{display:inline-block;width:48px;text-align:center;font-weight:600}
.action-buttons{display:flex;flex-direction:column;gap:14px;margin-bottom:30px}
.action-buttons .btn-primary{background:#e6462f;color:#fff;border:none;padding:18px 26px;font-size:1rem;font-weight:600;border-radius:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:.3s}
.action-buttons .btn-outline{background:#fff;border:2px solid #e6462f;color:#e6462f;padding:15px 26px;font-weight:600;font-size:.95rem;border-radius:40px;cursor:pointer;transition:.3s}
.action-buttons .btn-primary:hover{background:#c93722}
.action-buttons .btn-outline:hover{background:#e6462f;color:#fff}
.shipping-box{background:#f1faf1;border:1px solid #b9e3b9;padding:18px 20px;border-radius:12px;font-size:.85rem;line-height:1.4;color:#1a531a;display:flex;gap:12px;margin-bottom:18px}
.alert-low{background:#fdf2f2;border:1px solid #f5c2c7;color:#a23131;padding:10px 14px;border-radius:10px;font-size:.8rem;width:max-content;margin-bottom:15px}
.long-desc{line-height:1.55;color:#333;font-size:.93rem;white-space:pre-line}
.gallery-wrapper{display:flex;gap:14px}
@media (max-width:980px){.product-page{grid-template-columns:1fr}.gallery-wrapper{flex-direction:row}.product-thumbs{flex-direction:row;max-height:none;overflow:auto}.product-thumb{width:68px}}
@media (max-width:600px){.product-main{aspect-ratio:4/3}.price-final{font-size:1.7rem}h1{font-size:1.7rem}}
.dark .product-main{background:#1f1f1f}
.dark .product-thumb{background:#2a2a2a}
.dark .shipping-box{background:#173d17;border-color:#236a23;color:#bfeabf}
</style>
</head><body>
<header class="topbar" style="padding:14px 26px;display:flex;align-items:center;gap:28px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.06)">
  <div style="flex:0 0 auto"><a href="index.html" style="text-decoration:none;font-weight:700;color:#e6462f;font-size:1.2rem">Tienda3D</a></div>
  <nav style="display:flex;gap:18px;font-size:.9rem;flex:1 1 auto">
    <a href="catalogo.html">Cat√°logo</a>
    <a href="index.html#faq">FAQ</a>
  </nav>
  <div id="userArea" class="user-area" style="display:flex;align-items:center;gap:10px"></div>
  <button class="cart-btn" id="openCart" aria-label="Abrir carrito" style="background:#fff;border:1px solid #ddd;padding:8px 14px;border-radius:30px;cursor:pointer">üõí <span id="cartCount">0</span></button>
  <button id="darkToggle" class="btn small outline" style="padding:6px 12px">üåô</button>
</header>
<div id="toast"></div>
<div class="product-page">
  <div class="product-gallery">
    <div class="breadcrumb" id="breadcrumb"></div>
    <div class="gallery-wrapper">
      <div class="product-thumbs" id="thumbs"></div>
      <div class="product-main"><img id="mainImage" alt="Producto"></div>
    </div>
  </div>
  <div class="product-info" id="productInfo">
    <!-- Se rellena din√°micamente -->
  </div>
</div>
<!-- Carrito y modal (mismo markup que en index) -->
<aside id="cartDrawer" class="cart">
  <div class="cart-header"><h3>Tu carrito</h3><button id="closeCart">‚úï</button></div>
  <div id="cartAddedMsg" class="cart-added-msg"></div>
  <div id="cartItems" class="cart-items"></div>
  <div class="cart-footer">
    <div class="totals"><span>Total:</span><strong id="cartTotal">$0</strong></div>
    <button id="checkout" class="btn primary">Finalizar compra</button>
    <button id="clearCart" class="btn outline">Vaciar</button>
  </div>
</aside>
<div id="overlay" class="overlay"></div>
<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <h3>Entrega</h3>
    <form id="checkoutForm" class="checkout-form">
      <div class="form-row">
        <label>M√©todo de env√≠o:<br>
          <select id="inputEnvio">
            <option value="retiro">Retiro en taller (sin costo)</option>
            <option value="domicilio">Env√≠o a domicilio (Santiago, $2.990)</option>
          </select>
        </label>
        <label>Nombre:<br><input id="inputName" autocomplete="name"></label>
        <label>Apellidos:<br><input id="inputApellido" autocomplete="family-name"></label>
      </div>
      <div class="form-row">
        <label>RUT (Obligatorio):<br><input id="inputRut" autocomplete="off"></label>
      </div>
      <div class="form-row">
        <label>Direcci√≥n:<br><input id="inputDireccion" autocomplete="street-address"></label>
      </div>
      <div class="form-row">
        <label>Agregar Nota (Personalizaci√≥n producto):<br><input id="inputNotes" autocomplete="off"></label>
      </div>
      <div class="form-row">
        <label>C√≥digo postal (opcional):<br><input id="inputPostal" autocomplete="postal-code"></label>
      </div>
      <div class="form-row">
        <label>Regi√≥n:<br>
          <select id="inputRegion">
            <option value="">Selecciona regi√≥n</option>
          </select>
        </label>
        <label>Comuna:<br>
          <select id="inputComuna">
            <option value="">Selecciona comuna</option>
          </select>
        </label>
      </div>
      <div class="form-row">
        <label>Tel√©fono:<br><input id="inputTelefono" autocomplete="tel"></label>
      </div>
      <div class="modal-actions">
        <button type="button" id="confirmCheckout" class="btn primary">Confirmar</button>
        <button type="button" id="cancelCheckout" class="btn outline">Cancelar</button>
      </div>
    </form>
  </div>
</div>
<script src="script.js"></script>
<script>
// Fallback global para formatear precios si no existe window.money
if(typeof window.money !== 'function') {
  window.money = function(val) {
    return Number(val).toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
  };
}
  // Inserta Product JSON-LD din√°mico para SEO
  (function(){
    function qs(k){const u=new URL(location.href);return u.searchParams.get(k);} 
    const id = qs('id');
    if(!id || !window.PRODUCTS) return;
    const p = (window.PRODUCTS||[]).find(x=>String(x.id)===String(id));
    if(!p) return;
    const price = Number(p.discount? Math.round(p.price*(1-p.discount/100)) : p.price) || 0;
    const data = {
      "@context":"https://schema.org",
      "@type":"Product",
      "name": p.name,
      "image": [ (location.origin + '/' + (p.img||'img/placeholder.png')).replace(/([^:])\/\//g,'$1/') ],
      "description": p.name,
      "brand": {"@type":"Brand","name":"Misi√≥n 3D"},
      "offers": {"@type":"Offer","priceCurrency":"CLP","price": price,"availability":"https://schema.org/InStock","url": location.href}
    };
    const s = document.createElement('script'); s.type='application/ld+json'; s.textContent=JSON.stringify(data); document.head.appendChild(s);
  })();
</script>
<script>
// Esperar a que PRODUCTS est√© disponible
document.addEventListener('DOMContentLoaded', function() {
  // Dar tiempo a que script.js cargue PRODUCTS
  setTimeout(renderProductDetail, 100);
});

function getParam(name){return new URLSearchParams(location.search).get(name);} 
function starsHTML(v){const full=Math.floor(v);const half=v%1>=0.5;let s='';for(let i=0;i<full;i++)s+='‚òÖ';if(half)s+='‚òÜ';return `<span class="stars">${s}</span>`}
function renderProductDetail(){
  const id=getParam('id');
  if(!window.PRODUCTS || !PRODUCTS.length){
    console.warn('PRODUCTS no disponible a√∫n, reintentando...');
    setTimeout(renderProductDetail, 100);
    return;
  }
  const p=PRODUCTS.find(x=>String(x.id)===String(id));
  const info=document.getElementById('productInfo');
  const breadcrumb=document.getElementById('breadcrumb');
  if(!p){info.innerHTML='<p>Producto no encontrado. <a href="catalogo.html">Volver al cat√°logo</a></p>';return;}
  breadcrumb.innerHTML=`<a href='index.html'>Inicio</a> ‚Ä∫ ${p.name}`;
  // Galer√≠a simple (si en futuro p.gallery existe la usamos)
  const gallery=(p.gallery&&p.gallery.length?p.gallery:[p.img]);
  const thumbs=document.getElementById('thumbs');
  thumbs.innerHTML=gallery.map((g,i)=>`<div class='product-thumb ${i===0?'active':''}' data-img='${g}'><img src='${g}' alt='thumb'></div>`).join('');
  thumbs.querySelectorAll('.product-thumb').forEach(th=>th.onclick=()=>{document.getElementById('mainImage').src=th.dataset.img;thumbs.querySelectorAll('.product-thumb').forEach(x=>x.classList.remove('active'));th.classList.add('active');});
  document.getElementById('mainImage').src=gallery[0];
  const isLow=p.stock==='bajo';
  const daysDiff=(Date.now()-new Date(p.dateAdded))/86400000; let badges='';
  if(daysDiff<=21) badges+=`<span class='badge new'>Nuevo</span>`; if(p.discount) badges+=`<span class='badge discount'>-${p.discount}%</span>`;
  const priceOriginal=p.discount?`<span class='price-old'>${money(p.price)}</span>`:'';
  const finalPrice=p.discount?Math.round(p.price*(1-p.discount/100)):p.price;
  info.innerHTML=`<h1>${p.name}</h1>
  <div class='badges-line'>${badges}</div>
  <div class='rating-line'>${starsHTML(p.stars)} <span style='color:#555'>(${p.stars})</span> ¬∑ <span>${p.reviews} Rese√±a${p.reviews>1?'s':''}</span></div>
  <div class='price-block'>${priceOriginal}<span class='price-final'>${money(finalPrice)}</span></div>
  <div class='short-desc'>${p.name.includes('Calendario')?'Calendario detallado con todos los circuitos en relieve y acabado premium.':'Producto personalizado impreso en 3D.'}</div>
  <div class='stock-msg ${isLow?'stock-low':''}'>${isLow?'¬°Quedan pocas unidades!':'Stock disponible'}</div>
  <div class='qty-box'><button id='qtyMinus'>-</button><span id='qtyValue'>1</span><button id='qtyPlus'>+</button></div>
  <div class='action-buttons'>
    <button class='btn-primary' id='addCartBtn'>A√±adir al carrito</button>
    <button class='btn-outline' id='buyNowBtn'>Comprar ahora</button>
  </div>
  <div class='shipping-box'>üöö <div><strong>Tiempos estimados:</strong><br>1-3 d√≠as (Santiago y Regiones).</div></div>
  ${isLow?'<div class="alert-low">¬°Quedan pocas unidades para este pedido!</div>':''}
  <div class='long-desc'>${p.name.includes('Calendario')?`El Calendario F1 2026 ofrece una visi√≥n detallada de todas las fechas y ubicaciones de los Grandes Premios. Dise√±ado para aficionados avanzados, facilita la planificaci√≥n estrat√©gica y seguimiento de cada evento.\n\nImpreso en alta calidad con precisi√≥n y acabados mejorados.`:'Fabricado bajo pedido con materiales de alta calidad.'}</div>`;
  // Cantidad
  let qty=1;const val=document.getElementById('qtyValue');
  document.getElementById('qtyMinus').onclick=()=>{if(qty>1){qty--;val.textContent=qty;}};
  document.getElementById('qtyPlus').onclick=()=>{qty++;val.textContent=qty;};
  // A√±adir m√∫ltiples unidades de una sola vez sin spamear toasts
  function addBulk(id, cantidad, nombre){
    let it = cart.find(x=>x.id===id);
    if(it) it.qty += cantidad; else cart.push({id, qty:cantidad});
    save(); badge();
    if(typeof showToast === 'function') {
      showToast(`¬°${nombre} agregado${cantidad>1?` x${cantidad}`:''} al carrito!`, 'success');
    }
    openCart();
    render(id, nombre);
  }
  document.getElementById('addCartBtn').onclick=()=>addBulk(p.id, qty, p.name);
  document.getElementById('buyNowBtn').onclick=()=>{
    // Agregar productos seleccionados y redirigir a p√°gina de checkout dedicada
    let it = cart.find(x=>x.id===p.id);
    if(it) it.qty += qty; else cart.push({id:p.id, qty});
    save(); badge();
    window.location.href = 'checkout.html';
  };
}
</script>
<script type="module" src="firebase-rtdb.js"></script>
</body></html>