<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n | Mision3D</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/jpeg" href="img/Logo_Mision3d.jpg">
  <link rel="apple-touch-icon" href="img/Logo_Mision3d.jpg">
  <link rel="stylesheet" href="style.css">
  <!-- XLSX para exportaci√≥n a Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { background: #f7f7f7; }
    .admin-panel { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.07); padding: 32px 28px; }
    h1 { font-size: 2rem; margin-bottom: 18px; }
    .tabs { display: flex; gap: 18px; margin-bottom: 24px; }
    .tab { padding: 10px 22px; border-radius: 8px; background: #eee; cursor: pointer; font-weight: 600; }
    .tab.active { background: #e6462f; color: #fff; }
    .admin-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    .admin-table th, .admin-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; }
    .admin-table th { background: #fafafa; font-size: .98rem; }
    .admin-table td img { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; }
    .btn { padding: 7px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
    .btn.edit { background: #f7b731; color: #fff; }
    .btn.delete { background: #eb3b5a; color: #fff; }
    .btn.add { background: #20bf6b; color: #fff; margin-bottom: 18px; }
    .form-row { display: flex; gap: 14px; margin-bottom: 12px; }
    .form-row label { flex: 1; display: flex; flex-direction: column; font-size: .95rem; }
    .form-row input, .form-row textarea, .form-row select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: .97rem; }
    .form-actions { display: flex; gap: 10px; }
    .gallery-manager { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 12px; background: #fafafa; }
    .gallery-item { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .gallery-item input { flex: 1; }
    .gallery-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 2px solid #ddd; }
    .btn-gallery { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: .9rem; }
    .btn-gallery.add { background: #20bf6b; color: #fff; }
    .btn-gallery.remove { background: #eb3b5a; color: #fff; }
    .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .gallery-header h4 { margin: 0; font-size: 1rem; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginPanel" style="max-width:340px;margin:80px auto 0 auto;padding:32px 28px;background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.07);display:none">
    <h2 style="margin-bottom:18px">Acceso administrador</h2>
    <form id="loginForm">
      <label style="display:block;margin-bottom:12px;font-size:1rem">Contrase√±a:
        <input id="adminPass" type="password" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #ccc;font-size:1.1rem;margin-top:6px">
      </label>
      <button type="submit" class="btn add" style="width:100%">Entrar</button>
      <div id="loginError" style="color:#c00;font-size:.95rem;margin-top:10px;display:none"></div>
    </form>
  </div>
  <!-- Panel -->
  <div class="admin-panel" style="display:none">
    <h1>Panel de Administraci√≥n</h1>
    <div class="tabs">
  <div class="tab active" id="tabProductos">Productos</div>
  <div class="tab" id="tabPedidos">Pedidos</div>
    </div>
    <div id="productosPanel"></div>
    <div id="pedidosPanel" style="display:none">
      <div style="display:flex;gap:12px;align-items:center;margin:8px 0 12px 0;flex-wrap:wrap">
        <input id="pedidoSearch" type="text" placeholder="Buscar por email, orden o ID" style="flex:1;min-width:220px;padding:8px 10px;border:1px solid #ccc;border-radius:6px">
        <input id="pedidoFrom" type="date" style="padding:8px 10px;border:1px solid #ccc;border-radius:6px">
        <input id="pedidoTo" type="date" style="padding:8px 10px;border:1px solid #ccc;border-radius:6px">
        <select id="pedidoQuickRange" style="padding:8px 10px;border:1px solid #ccc;border-radius:6px">
          <option value="">Rango r√°pido</option>
          <option value="today">Hoy</option>
          <option value="7d">√öltimos 7 d√≠as</option>
          <option value="month">Este mes</option>
          <option value="all">Todos</option>
        </select>
        <select id="pedidoFilter" style="padding:8px 10px;border:1px solid #ccc;border-radius:6px">
          <option value="todos">Todos</option>
          <option value="pendiente">Pendiente</option>
          <option value="pagado">Pagado</option>
          <option value="enviado">Enviado</option>
          <option value="cancelado">Cancelado</option>
        </select>
        <button id="pedidoRefresh" class="btn" style="background:#0ea5e9;color:#fff">Actualizar</button>
        <button id="pedidoExport" class="btn" style="background:#22c55e;color:#fff">Exportar CSV</button>
        <button id="pedidoExportXlsx" class="btn" style="background:#10b981;color:#fff">Exportar XLSX</button>
      </div>
      <table class="admin-table" id="pedidosTable">
        <thead>
          <tr><th>ID</th><th>Usuario</th><th>Estado</th><th>Total</th><th>Items</th><th>Fecha</th><th>Acciones</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    document.addEventListener('DOMContentLoaded', () => {
      // --- L√≥gica de pesta√±as ---
      const tabProductos = document.getElementById('tabProductos');
      const tabPedidos = document.getElementById('tabPedidos');
      const productosPanel = document.getElementById('productosPanel');
      const pedidosPanel = document.getElementById('pedidosPanel');
      function activarTab(tab) {
        if(tab === 'productos') {
          tabProductos.classList.add('active');
          tabPedidos.classList.remove('active');
          productosPanel.style.display = '';
          pedidosPanel.style.display = 'none';
        } else {
          tabProductos.classList.remove('active');
          tabPedidos.classList.add('active');
          productosPanel.style.display = 'none';
          pedidosPanel.style.display = '';
          renderPedidos();
        }
      }
      tabProductos.onclick = () => activarTab('productos');
      tabPedidos.onclick = () => activarTab('pedidos');

      // --- Pedidos: renderizado y gesti√≥n ---
      async function renderPedidos() {
        const tbody = document.querySelector('#pedidosTable tbody');
        tbody.innerHTML = '<tr><td colspan="6">Cargando pedidos...</td></tr>';
        let { data, error } = await supabase.from('pedidos').select('*').order('created_at', { ascending: false });
        if(error) {
          tbody.innerHTML = `<tr><td colspan="6" style="color:#c00">Error cargando pedidos: ${error.message}</td></tr>`;
          return;
        }
        if(!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="color:#888">No hay pedidos registrados.</td></tr>';
          return;
        }
        // Aplicar filtros
        const q = (document.getElementById('pedidoSearch')?.value || '').trim().toLowerCase();
        const f = (document.getElementById('pedidoFilter')?.value || 'todos');
        const fFromVal = (document.getElementById('pedidoFrom')?.value || '').trim();
        const fToVal   = (document.getElementById('pedidoTo')?.value || '').trim();
        const fromTs = fFromVal ? new Date(fFromVal + 'T00:00:00') : null;
        const toTs   = fToVal   ? new Date(fToVal   + 'T23:59:59') : null;
        data = data.filter(p => {
          const estado = p.estado || p.status || '';
          if (f !== 'todos' && estado !== f) return false;
          // Rango de fechas
          const createdAt = p.created_at || p.createdAt || p.createdat || null;
          if (createdAt && (fromTs || toTs)) {
            const ct = new Date(createdAt).getTime();
            if (fromTs && ct < fromTs.getTime()) return false;
            if (toTs && ct > toTs.getTime()) return false;
          }
          if (!q) return true;
          const hay = [p.email, p.user_id, p.commerce_order, p.commerceOrder, p.id]
            .map(v => String(v||'').toLowerCase())
            .some(s => s.includes(q));
          return hay;
        });

        // Guarda √∫ltima lista filtrada para exportaci√≥n
        window._pedidosFiltered = data.slice();

        tbody.innerHTML = '';
        for(const pedido of data) {
          const tr = document.createElement('tr');
          // Convertir fecha a hora de Chile
          let fechaChile = '';
          const _createdAt = pedido.created_at || pedido.createdAt || pedido.createdat;
          if (_createdAt) {
            try {
              const d = new Date(_createdAt);
              fechaChile = d.toLocaleString('es-CL', { timeZone: 'America/Santiago' });
            } catch {
              fechaChile = String(_createdAt).slice(0,16).replace('T',' ');
            }
          }
          const items = Array.isArray(pedido.items) ? pedido.items : [];
          const itemsText = items.map(it => {
            const name = it?.name || it?.title || 'Producto';
            const qty = Number(it?.qty || 1);
            const unit = Number((it?.price ?? it?.unit_price) || 0);
            return `${name} (x${qty} a ${money(unit)})`;
          }).join(', ') || 'Sin items';
          tr.innerHTML = `
            <td>${pedido.id}</td>
            <td>${pedido.email || pedido.user_id || ''}</td>
            <td>
              <select data-id="${pedido.id}" class="estado-select">
                <option value="pendiente"${pedido.estado==='pendiente'?' selected':''}>pendiente</option>
                <option value="pagado"${pedido.estado==='pagado'?' selected':''}>pagado</option>
                <option value="enviado"${pedido.estado==='enviado'?' selected':''}>enviado</option>
                <option value="cancelado"${pedido.estado==='cancelado'?' selected':''}>cancelado</option>
              </select>
            </td>
            <td>${money(pedido.total_clp || pedido.total || 0)}</td>
            <td>${itemsText}</td>
            <td>${fechaChile}</td>
            <td>
              <button data-id="${pedido.id}" class="mark-paid-btn" style="color:#fff;background:#16a34a;border:none;padding:4px 8px;border-radius:4px;margin-right:8px;">Marcar pagado + email</button>
              <button data-id="${pedido.id}" class="eliminar-btn" style="color:#fff;background:#e11d48;border:none;padding:4px 8px;border-radius:4px;">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
        // Eventos de cambio de estado
        tbody.querySelectorAll('.estado-select').forEach(sel => {
          sel.addEventListener('change', async function() {
            const pedidoId = this.getAttribute('data-id');
            const nuevoEstado = this.value;
            const { error } = await supabase.from('pedidos').update({ estado: nuevoEstado, status: nuevoEstado }).eq('id', pedidoId);
            if(error) {
              showAdminToast('Error actualizando estado: '+error.message, 'error');
            } else {
              showAdminToast('Estado actualizado', 'success');
            }
          });
        });
        // Eventos de eliminar
        tbody.querySelectorAll('.eliminar-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            if(!confirm('¬øSeguro que deseas eliminar este pedido?')) return;
            const pedidoId = this.getAttribute('data-id');
            const { error } = await supabase.from('pedidos').delete().eq('id', pedidoId);
            if(error) {
              showAdminToast('Error eliminando pedido: '+error.message, 'error');
            } else {
              showAdminToast('Pedido eliminado', 'success');
              renderPedidos();
            }
          });
        });
        // Evento marcar pagado + email
        tbody.querySelectorAll('.mark-paid-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            const id = this.getAttribute('data-id');
            if(!confirm('¬øMarcar como PAGADO y enviar correo de confirmaci√≥n al cliente?')) return;
            let adminKey = sessionStorage.getItem('ADMIN_KEY');
            if (!adminKey) {
              adminKey = prompt('Ingresa la ADMIN_KEY');
              if (!adminKey) return;
              sessionStorage.setItem('ADMIN_KEY', adminKey);
            }
            try {
              const base = window.location.origin;
              const resp = await fetch(base + '/api/admin/pedidos/' + encodeURIComponent(id) + '/marcar-pagado', {
                method: 'POST',
                headers: { 'x-admin-key': adminKey }
              });
              const data = await resp.json().catch(()=>({}));
              if (!resp.ok) {
                showAdminToast('Error: ' + (data?.detail || data?.error || resp.status), 'error');
                return;
              }
              showAdminToast('Pedido marcado como pagado y correo enviado', 'success');
              renderPedidos();
            } catch(e){
              showAdminToast('Error realizando la acci√≥n: ' + (e?.message||e), 'error');
            }
          });
        });
        // Filtros: listeners
        const search = document.getElementById('pedidoSearch');
        const filter = document.getElementById('pedidoFilter');
        const refresh = document.getElementById('pedidoRefresh');
        const fromInp = document.getElementById('pedidoFrom');
        const toInp   = document.getElementById('pedidoTo');
        const quick   = document.getElementById('pedidoQuickRange');
        const exportBtn = document.getElementById('pedidoExport');
        const exportXlsxBtn = document.getElementById('pedidoExportXlsx');
        if (search && !search._binded) { search._binded = true; search.addEventListener('input', () => renderPedidos()); }
        if (filter && !filter._binded) { filter._binded = true; filter.addEventListener('change', () => renderPedidos()); }
        if (refresh && !refresh._binded) { refresh._binded = true; refresh.addEventListener('click', () => renderPedidos()); }
        if (fromInp && !fromInp._binded) { fromInp._binded = true; fromInp.addEventListener('change', () => renderPedidos()); }
        if (toInp && !toInp._binded) { toInp._binded = true; toInp.addEventListener('change', () => renderPedidos()); }
        if (quick && !quick._binded) {
          quick._binded = true;
          quick.addEventListener('change', () => {
            const today = new Date();
            const toStr = (d)=> d.toISOString().slice(0,10);
            if (quick.value === 'today') {
              const s = toStr(today);
              if (fromInp) fromInp.value = s;
              if (toInp) toInp.value = s;
            } else if (quick.value === '7d') {
              const past = new Date(today.getTime() - 6*24*60*60*1000);
              if (fromInp) fromInp.value = toStr(past);
              if (toInp) toInp.value = toStr(today);
            } else if (quick.value === 'month') {
              const first = new Date(today.getFullYear(), today.getMonth(), 1);
              if (fromInp) fromInp.value = toStr(first);
              if (toInp) toInp.value = toStr(today);
            } else if (quick.value === 'all') {
              if (fromInp) fromInp.value = '';
              if (toInp) toInp.value = '';
            }
            renderPedidos();
          });
        }
        if (exportBtn && !exportBtn._binded) {
          exportBtn._binded = true;
          exportBtn.addEventListener('click', () => {
            const rows = (window._pedidosFiltered || []).map(p => ({
              id: p.id,
              email: p.email || p.user_id || '',
              estado: p.estado || p.status || '',
              total: Number(p.total_clp || p.total || 0),
              created_at: p.created_at || p.createdAt || p.createdat || '',
              commerce_order: p.commerce_order || p.commerceOrder || '',
              items_count: Array.isArray(p.items) ? p.items.length : 0,
              items: (Array.isArray(p.items) ? p.items : []).map(it => {
                const name = it?.name || it?.title || 'Producto';
                const qty = Number(it?.qty || 1);
                const unit = Number((it?.price ?? it?.unit_price) || 0);
                return `${name} (x${qty} a ${money(unit)})`;
              }).join(' | ')
            }));
            if (!rows.length) { showAdminToast('No hay datos para exportar', 'error'); return; }
            const header = Object.keys(rows[0]);
            const csv = [header.join(',')].concat(rows.map(r => header.map(k => {
              const v = r[k];
              const s = (typeof v === 'string') ? v.replace(/"/g,'""') : String(v);
              return '"' + s + '"';
            }).join(','))).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pedidos.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          });
        }
        if (exportXlsxBtn && !exportXlsxBtn._binded) {
          exportXlsxBtn._binded = true;
          exportXlsxBtn.addEventListener('click', () => {
            const rows = (window._pedidosFiltered || []).map(p => ({
              id: p.id,
              email: p.email || p.user_id || '',
              estado: p.estado || p.status || '',
              total: Number(p.total_clp || p.total || 0),
              created_at: p.created_at || p.createdAt || p.createdat || '',
              commerce_order: p.commerce_order || p.commerceOrder || '',
              items_count: Array.isArray(p.items) ? p.items.length : 0,
              items: (Array.isArray(p.items) ? p.items : []).map(it => {
                const name = it?.name || it?.title || 'Producto';
                const qty = Number(it?.qty || 1);
                const unit = Number((it?.price ?? it?.unit_price) || 0);
                return `${name} (x${qty} a ${money(unit)})`;
              }).join(' | ')
            }));
            if (!rows.length) { showAdminToast('No hay datos para exportar', 'error'); return; }
            try {
              const wb = XLSX.utils.book_new();
              // Hoja 1: Pedidos (resumen con Items en una sola celda)
              const wsResumen = XLSX.utils.json_to_sheet(rows);
              XLSX.utils.book_append_sheet(wb, wsResumen, 'Pedidos');

              // Mejora opcional: Hoja 2 con detalle por √≠tem
              const detalle = [];
              (window._pedidosFiltered || []).forEach(p => {
                const items = Array.isArray(p.items) ? p.items : [];
                const base = {
                  pedido_id: p.id,
                  email: p.email || p.user_id || '',
                  estado: p.estado || p.status || '',
                  created_at: p.created_at || p.createdAt || p.createdat || '',
                };
                if (items.length === 0) {
                  detalle.push({ ...base, item: '', qty: 0, unit_price: 0, total_item: 0 });
                } else {
                  items.forEach(it => {
                    const qty = Number(it?.qty || 1);
                    const price = Number(it?.price || 0);
                    detalle.push({
                      ...base,
                      item: it?.name || it?.title || 'Producto',
                      qty,
                      unit_price: price,
                      total_item: qty * price
                    });
                  });
                }
              });
              if (detalle.length) {
                const wsDetalle = XLSX.utils.json_to_sheet(detalle);
                XLSX.utils.book_append_sheet(wb, wsDetalle, 'DetalleItems');
              }
              XLSX.writeFile(wb, 'pedidos.xlsx');
            } catch(e){
              console.error('XLSX export error:', e);
              showAdminToast('Error exportando a XLSX', 'error');
            }
          });
        }
      }
      const PASSWORD = "admin123";
      const SUPABASE_URL = 'https://ytuwkynphdttotifgyaf.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0dXdreW5waGR0dG90aWZneWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3ODUyMzYsImV4cCI6MjA3NzM2MTIzNn0.JIFDBzpYTcChc1fnmp6pFL0K9SZPnn2ltp4iKxLdSus';
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const money = v => Number(v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      const toNum  = v => Number(v)||0;
      let PRODUCTS = [];
      let mapProductos = {};
      let editingId = null;
      let galleryImages = [];

      async function supaGetProductos() {
        const { data, error } = await supabase.from('productos').select('*');
        if (error) throw error;
        mapProductos = Object.fromEntries((data||[]).map(p=>[p.id, p]));
        PRODUCTS = data || [];
      }
      async function supaUpsertProducto(id, producto) {
        // Si id existe (editar), lo incluimos; si no, lo omitimos (crear)
        let prod = { ...producto };
        if (id) prod.id = id;
        // Solo enviar campos v√°lidos seg√∫n la tabla
  const camposValidos = ['id','name','price','img','stock','descripcion','category','discount','stars','reviews','gallery','variants'];
        let prodFinal = {};
        for(const k of camposValidos){
          if(typeof prod[k] !== 'undefined') prodFinal[k] = prod[k];
        }
        const { error } = await supabase.from('productos').upsert([prodFinal]);
        if (error) throw error;
      }
      async function supaDeleteProducto(id) {
        const { error } = await supabase.from('productos').delete().eq('id', id);
        if (error) throw error;
      }
      function showAdminToast(msg, type='success'){
        let toast = document.getElementById('adminToast');
        if(!toast){
          toast = document.createElement('div');
          toast.id = 'adminToast';
          toast.style.position = 'fixed';
          toast.style.bottom = '32px';
          toast.style.left = '50%';
          toast.style.transform = 'translateX(-50%)';
          toast.style.background = (type==='success') ? '#20bf6b' : '#eb3b5a';
          toast.style.color = '#fff';
          toast.style.padding = '14px 32px';
          toast.style.borderRadius = '8px';
          toast.style.fontSize = '1.1rem';
          toast.style.boxShadow = '0 2px 8px rgba(0,0,0,.12)';
          toast.style.zIndex = 9999;
          document.body.appendChild(toast);
        }
        toast.textContent = msg;
        toast.style.display = '';
        setTimeout(()=> toast.style.display='none', 1800);
      }
      function slugify(str){
        return (str||'')
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
          .replace(/[^a-z0-9]+/g,'-')
          .replace(/(^-|-$)/g,'')
          .slice(0,40) || ('p-'+Date.now());
      }
      
      // Funciones para manejar variantes/subproductos
      let variantsData = [];
      
      function renderVariants(){
        const container = document.getElementById('variantsContainer');
        if(!container) return;
        container.innerHTML = '';
        
        if(variantsData.length === 0){
          container.innerHTML = '<p style="color:#888;font-size:.9rem;margin:0">No hay variantes. Ej: tama√±os, colores, versiones.</p>';
          return;
        }
        
        variantsData.forEach((variant, index) => {
          const div = document.createElement('div');
          div.className = 'gallery-item';
          div.style.flexWrap = 'wrap';
          div.innerHTML = `
            <input type="text" value="${variant.name || ''}" data-index="${index}" data-field="name" placeholder="Nombre (Ej: Grande, Azul, Con base)" style="flex:2">
            <input type="number" value="${variant.price || 0}" data-index="${index}" data-field="price" placeholder="Precio diferencial" min="0" style="flex:1">
            <button type="button" class="btn-gallery remove" data-index="${index}">üóëÔ∏è</button>
            <div style="width:100%;margin-top:8px;display:flex;gap:8px;align-items:center">
              <input type="file" accept="image/*" data-index="${index}" data-field="image" style="flex:1;font-size:.9rem">
              ${variant.image ? `<img src="${variant.image}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #ddd">` : ''}
              ${variant.image ? `<span style="font-size:.85rem;color:#059669">‚úì Imagen cargada</span>` : ''}
            </div>
          `;
          container.appendChild(div);
          
          // Event listeners para actualizar
          const inputs = div.querySelectorAll('input[type="text"], input[type="number"]');
          inputs.forEach(input => {
            input.addEventListener('input', (e) => {
              const idx = parseInt(e.target.dataset.index);
              const field = e.target.dataset.field;
              if(field === 'name'){
                variantsData[idx].name = e.target.value.trim();
              } else if(field === 'price'){
                variantsData[idx].price = parseFloat(e.target.value) || 0;
              }
            });
          });
          
          // Event listener para el archivo de imagen
          const fileInput = div.querySelector('input[type="file"]');
          if(fileInput){
            fileInput.addEventListener('change', async (e) => {
              const idx = parseInt(e.target.dataset.index);
              const file = e.target.files[0];
              if(!file) return;
              
              try {
                // Subir imagen a Supabase Storage
                const fileName = `variant-${Date.now()}-${file.name}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                  .from('productos')
                  .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: false
                  });
                
                if(uploadError) throw uploadError;
                
                // Obtener URL p√∫blica
                const { data: urlData } = supabase.storage
                  .from('productos')
                  .getPublicUrl(fileName);
                
                variantsData[idx].image = urlData.publicUrl;
                renderVariants();
                showAdminToast('Imagen subida correctamente', 'success');
              } catch (err) {
                console.error('Error subiendo imagen:', err);
                showAdminToast('Error subiendo imagen: ' + err.message, 'error');
              }
            });
          }
          
          // Bot√≥n eliminar
          const btnRemove = div.querySelector('.btn-gallery.remove');
          btnRemove.addEventListener('click', () => {
            variantsData.splice(index, 1);
            renderVariants();
          });
        });
      }
      
      function addVariant(){
        variantsData.push({ name: '', price: 0, image: '' });
        renderVariants();
      }
      
      // Funciones para manejar la galer√≠a
      function renderGallery(){
        const container = document.getElementById('galleryContainer');
        if(!container) return;
        container.innerHTML = '';
        
        if(galleryImages.length === 0){
          container.innerHTML = '<p style="color:#888;font-size:.9rem;margin:0">No hay im√°genes adicionales. Usa el bot√≥n "+" para agregar.</p>';
          return;
        }
        
        galleryImages.forEach((imgUrl, index) => {
          const div = document.createElement('div');
          div.className = 'gallery-item';
          div.innerHTML = `
            <input type="text" value="${imgUrl}" data-index="${index}" placeholder="img/foto.png o https://...">
            ${imgUrl ? `<img src="${imgUrl}" onerror="this.style.display='none'">` : ''}
            <button type="button" class="btn-gallery remove" data-index="${index}">üóëÔ∏è Eliminar</button>
          `;
          container.appendChild(div);
          
          // Event listener para actualizar la URL
          const input = div.querySelector('input');
          input.addEventListener('input', (e) => {
            galleryImages[index] = e.target.value.trim();
            renderGallery();
          });
          
          // Event listener para eliminar
          const btnRemove = div.querySelector('.btn-gallery.remove');
          btnRemove.addEventListener('click', () => {
            galleryImages.splice(index, 1);
            renderGallery();
          });
        });
      }
      
      function addGalleryImage(){
        galleryImages.push('');
        renderGallery();
      }
      function renderProductos(){
        // Asegura que la tabla y el bot√≥n siempre est√©n presentes
        let productosPanel = document.getElementById('productosPanel');
        if (!productosPanel) return;
        productosPanel.innerHTML = `
          <button class="btn add" id="btnAddProducto">+ Agregar producto</button>
          <table class="admin-table" id="productosTable">
            <thead>
              <tr><th>Imagen</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>Categor√≠a</th><th>Acciones</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="productoFormWrap" style="display:none">
            <h3 id="formTitle">Agregar producto</h3>
            <form id="productoForm">
              <div class="form-row">
                <label>Nombre<input id="prodName" required></label>
                <label>Precio (CLP)<input id="prodPrice" type="number" min="0" required></label>
              </div>
              <div class="form-row">
                <label>Imagen Principal (URL)<input id="prodImg" required placeholder="img/archivo.png o https://..."></label>
                <label>Stock
                  <select id="prodStock">
                    <option value="disponible">Disponible</option>
                    <option value="bajo">Bajo</option>
                  </select>
                </label>
              </div>
              <div class="gallery-manager">
                <div class="gallery-header">
                  <h4>üì∏ Galer√≠a de Im√°genes Adicionales</h4>
                  <button type="button" class="btn-gallery add" id="btnAddGalleryImg">+ Agregar imagen</button>
                </div>
                <div id="galleryContainer"></div>
              </div>
              <div class="gallery-manager" style="margin-top:16px">
                <div class="gallery-header">
                  <h4>üîÄ Variantes / Subproductos</h4>
                  <button type="button" class="btn-gallery add" id="btnAddVariant">+ Agregar variante</button>
                </div>
                <div id="variantsContainer"></div>
              </div>
              <div class="form-row">
                <label>Categor√≠a
                  <input id="prodCat" list="catList" placeholder="Ej: Calendarios">
                  <datalist id="catList"></datalist>
                </label>
                <label>Descuento (%)<input id="prodDiscount" type="number" min="0" max="90" value="0"></label>
              </div>
              <div class="form-row">
                <label>Descripci√≥n<textarea id="prodDesc" rows="2" placeholder="Opcional"></textarea></label>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn add" id="btnSave">Guardar</button>
                <button type="button" class="btn delete" id="cancelForm">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        // Renderiza productos en el tbody
        const tbody = productosPanel.querySelector('#productosTable tbody');
        if (PRODUCTS.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" style="color:#888">Sin productos</td></tr>`;
        } else {
          tbody.innerHTML = '';
          PRODUCTS.forEach((p) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><img src="${p.img}" alt="img"></td>
              <td>${p.name||''}</td>
              <td>${money(p.price)}</td>
              <td>${p.stock||''}</td>
              <td>${p.category||'Otros'}</td>
              <td>
                <button class='btn edit' data-id='${p.id}'>Editar</button>
                <button class='btn delete' data-id='${p.id}'>Eliminar</button>
              </td>`;
            tbody.appendChild(tr);
          });
        }
        // Reasignar eventos
        productosPanel.querySelectorAll('.edit').forEach(btn => btn.onclick = ()=> showForm(btn.dataset.id));
        productosPanel.querySelectorAll('.delete').forEach(btn => btn.onclick = ()=> deleteProducto(btn.dataset.id));
        const btnCancel = productosPanel.querySelector('#cancelForm');
        if(btnCancel) btnCancel.onclick = hideForm;
        const btnAdd = productosPanel.querySelector('#btnAddProducto');
        if(btnAdd) btnAdd.onclick = ()=> showForm(null);
        const form = productosPanel.querySelector('#productoForm');
        if(form) form.onsubmit = async (e)=>{
          e.preventDefault();
          const btn = productosPanel.querySelector('#btnSave');
          btn.disabled = true; btn.textContent = 'Guardando...';
          const data = {
            name: productosPanel.querySelector('#prodName').value.trim(),
            price: toNum(productosPanel.querySelector('#prodPrice').value),
            img: productosPanel.querySelector('#prodImg').value.trim(),
            stock: productosPanel.querySelector('#prodStock').value,
            descripcion: productosPanel.querySelector('#prodDesc').value.trim(),
            category: productosPanel.querySelector('#prodCat').value.trim(),
            discount: toNum(productosPanel.querySelector('#prodDiscount').value),
            stars: toNum((mapProductos[editingId]?.stars) ?? 5),
            reviews: toNum((mapProductos[editingId]?.reviews) ?? 0),
            gallery: galleryImages.filter(url => url.trim() !== ''),
            variants: variantsData.filter(v => v.name && v.name.trim() !== '')
          };
          if(!data.name || !data.img || data.price<0){
            alert('Completa nombre, imagen y precio v√°lido.'); btn.disabled=false; btn.textContent='Guardar'; return;
          }
          try {
            const id = editingId || slugify(data.name);
            try {
              await supaUpsertProducto(id, data);
              await supaGetProductos();
              renderProductos();
              hideForm();
              showAdminToast('Producto guardado correctamente', 'success');
            } catch (err) {
              // Mostrar error detallado de Supabase
              if (err && err.message) {
                console.error('[Supabase] Error:', err.message, err.details || '', err.hint || '', err.code || '');
                alert('Error Supabase: ' + err.message + (err.details ? ('\n' + err.details) : ''));
              } else {
                console.error('[Supabase] Error:', err);
              }
              showAdminToast('Error guardando en Supabase', 'error');
            }
          } finally {
            btn.disabled = false; btn.textContent = 'Guardar';
            editingId = null;
          }
        };
      }
      function showForm(id=null){
        const wrap = document.getElementById('productoFormWrap');
        editingId = id;
        if(!id){
          document.getElementById('formTitle').textContent = 'Agregar producto';
          document.getElementById('prodName').value = '';
          document.getElementById('prodPrice').value = 0;
          document.getElementById('prodImg').value = '';
          document.getElementById('prodStock').value = 'disponible';
          document.getElementById('prodDesc').value = '';
          document.getElementById('prodCat').value = '';
          document.getElementById('prodDiscount').value = 0;
          galleryImages = [];
          variantsData = [];
        }else{
          const p = mapProductos[id] || {};
          document.getElementById('formTitle').textContent = id ? 'Editar producto' : 'Agregar producto';
          document.getElementById('prodName').value = p.name || '';
          document.getElementById('prodPrice').value = p.price || 0;
          document.getElementById('prodImg').value = p.img || '';
          // Cargar galer√≠a existente
          if(p.gallery && Array.isArray(p.gallery)){
            galleryImages = [...p.gallery];
          } else if(p.gallery && typeof p.gallery === 'string'){
            try {
              galleryImages = JSON.parse(p.gallery);
            } catch(e) {
              galleryImages = [];
            }
          } else {
            galleryImages = [];
          }
          // Cargar variantes existentes
          if(p.variants && Array.isArray(p.variants)){
            variantsData = [...p.variants];
          } else if(p.variants && typeof p.variants === 'string'){
            try {
              variantsData = JSON.parse(p.variants);
            } catch(e) {
              variantsData = [];
            }
          } else {
            variantsData = [];
          }
          document.getElementById('prodStock').value = p.stock || 'disponible';
          document.getElementById('prodDesc').value = p.descripcion || '';
          document.getElementById('prodCat').value = p.category || '';
          document.getElementById('prodDiscount').value = p.discount || 0;
        }
        renderGallery();
        renderVariants();
        wrap.style.display = '';
        
        // Configurar bot√≥n de agregar imagen
        const btnAddImg = document.getElementById('btnAddGalleryImg');
        if(btnAddImg){
          btnAddImg.onclick = addGalleryImage;
        }
        
        // Configurar bot√≥n de agregar variante
        const btnAddVariant = document.getElementById('btnAddVariant');
        if(btnAddVariant){
          btnAddVariant.onclick = addVariant;
        }
      }
      function hideForm(){ document.getElementById('productoFormWrap').style.display='none'; }
      async function deleteProducto(id){
        if(!confirm('¬øEliminar producto?')) return;
        try {
          await supaDeleteProducto(id);
          PRODUCTS = PRODUCTS.filter(x=>x.id!==id);
          delete mapProductos[id];
          renderProductos();
          showAdminToast('Producto eliminado', 'success');
        } catch (err) {
          showAdminToast('Error eliminando en Supabase', 'error');
        }
      }
      const btnCancel = document.getElementById('cancelForm');
      if(btnCancel) btnCancel.onclick = hideForm;
      const btnAdd = document.getElementById('btnAddProducto');
      if(btnAdd) btnAdd.onclick = ()=> showForm(null);
      const form = document.getElementById('productoForm');
      if(form) form.onsubmit = async (e)=>{
        e.preventDefault();
        const btn = document.getElementById('btnSave');
        btn.disabled = true; btn.textContent = 'Guardando...';
        const data = {
          name: document.getElementById('prodName').value.trim(),
          price: toNum(document.getElementById('prodPrice').value),
          img: document.getElementById('prodImg').value.trim(),
          stock: document.getElementById('prodStock').value,
          descripcion: document.getElementById('prodDesc').value.trim(),
          category: document.getElementById('prodCat').value.trim(),
          discount: toNum(document.getElementById('prodDiscount').value),
          stars: toNum((mapProductos[editingId]?.stars) ?? 5),
          reviews: toNum((mapProductos[editingId]?.reviews) ?? 0),
          dateAdded: (mapProductos[editingId]?.dateAdded) || new Date().toISOString().slice(0,10)
        };
        if(!data.name || !data.img || data.price<0){
          alert('Completa nombre, imagen y precio v√°lido.'); btn.disabled=false; btn.textContent='Guardar'; return;
        }
        try {
          const id = editingId || slugify(data.name);
          await supaUpsertProducto(id, data);
          await supaGetProductos();
          renderProductos();
          hideForm();
          showAdminToast('Producto guardado correctamente', 'success');
        } catch (err) {
          showAdminToast('Error guardando en Supabase', 'error');
        } finally {
          btn.disabled = false; btn.textContent = 'Guardar';
          editingId = null;
        }
      };
      async function initAdmin(){
        // Carga desde Supabase
        try {
          await supaGetProductos();
          console.log('[Admin] Productos desde Supabase:', PRODUCTS.length);
        } catch (err) {
          showAdminToast('Error cargando productos de Supabase', 'error');
          PRODUCTS = [];
          mapProductos = {};
        }
        // Poblar datalist de categor√≠as
        const dl = document.getElementById('catList');
        if(dl){
          dl.innerHTML = '';
          const cats = Array.from(new Set(PRODUCTS.map(p=>p.category).filter(Boolean)));
          cats.forEach(c=>{
            const opt = document.createElement('option');
            opt.value = c; dl.appendChild(opt);
          });
        }
        renderProductos();
        // Limpiar pedidos al iniciar
        const tbody = document.querySelector('#pedidosTable tbody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="color:#888">Selecciona la pesta√±a Pedidos para ver √≥rdenes.</td></tr>';
      }
      const loginPanel = document.getElementById('loginPanel');
      const adminPanel = document.querySelector('.admin-panel');
      if(adminPanel) adminPanel.style.display = 'none';
      if(loginPanel) loginPanel.style.display = '';
      const loginForm = document.getElementById('loginForm');
      if(loginForm) loginForm.onsubmit = (e)=>{
        e.preventDefault();
        const pass = document.getElementById('adminPass').value;
        if(pass === PASSWORD){
          if(loginPanel) loginPanel.style.display = 'none';
          if(adminPanel) adminPanel.style.display = '';
          initAdmin(); // carga datos al entrar
        }else{
          const err = document.getElementById('loginError');
          if(err){ err.textContent = 'Contrase√±a incorrecta'; err.style.display = ''; }
        }
      };
    });
  </script>
  </body>
</html>
